# Docker Compose for University Deployment E2E Tests
# Tests OIDC authentication + CEL RBAC policies with a single-org setup
#
# Port configuration (override via environment variables for parallel testing):
#   GATEWAY_PORT - Gateway HTTP port (default: 3000)
#   KEYCLOAK_PORT - Keycloak port (default: 8080)
#   QDRANT_HTTP_PORT - Qdrant HTTP port (default: 6333)
#   QDRANT_GRPC_PORT - Qdrant gRPC port (default: 6334)
#
# This deployment demonstrates the IdP-agnostic authentication architecture:
# - Single "university" organization with department teams (cs-faculty, med-research, etc.)
# - JIT provisioning: new users are automatically added to the university org
# - SSO group mappings: IdP groups like /cs/faculty map to teams like cs-faculty
# - Authorization uses database memberships, not JWT group claims
# - CEL policies evaluate subject.org_ids/team_ids from database
#
# Pre-configured via test setup script:
# - Single "university" organization with 6 department teams
# - 15 users with team memberships matching Keycloak groups
# - SSO group mappings for JIT team assignment
#
# Usage:
#   cd deploy/tests && pnpm test university      # Run university deployment tests
#   cd deploy/tests && pnpm test -- --grep "CEL" # Run specific test patterns
#
# Test credentials (from Keycloak realm):
#   | Role        | Username     | Password      |
#   |-------------|--------------|---------------|
#   | super_admin | admin_super  | admin123      |
#   | org_admin   | cs_admin     | orgadmin123   |
#   | team_admin  | prof_smith   | teamadmin123  |
#   | user        | phd_bob      | user123       |
#
# Endpoints:
# - Gateway: http://localhost:3000
# - Keycloak: http://localhost:8080
# - Keycloak Admin: http://localhost:8080 (admin/admin)

services:
  gateway:
    image: hadrian:local
    build:
      context: ..
      dockerfile: Dockerfile
    ports:
      - "${GATEWAY_PORT:-3000}:8080"
    extra_hosts:
      # Allow gateway to reach localhost:8080 (Keycloak) from inside the container
      - "localhost:host-gateway"
    volumes:
      # Use university config with CEL RBAC policies
      - ./config/hadrian.university.toml:/app/config/hadrian.toml:ro
      - gateway-data:/app/data
    environment:
      - RUST_LOG=gateway=debug,info
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - REDIS_URL=redis://redis:6379
      - QDRANT_URL=http://qdrant:6333
      # Vault Configuration
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=dev-only-token
      # OIDC Configuration
      - OIDC_ISSUER_URL=http://keycloak:8080/realms/hadrian
      - OIDC_CLIENT_ID=hadrian-gateway
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - OIDC_AUDIENCE=hadrian-gateway
      # JWT validation
      - JWT_ISSUER=http://keycloak:8080/realms/hadrian
      - JWT_AUDIENCE=hadrian-gateway
      - JWKS_URL=http://keycloak:8080/realms/hadrian/protocol/openid-connect/certs
    depends_on:
      keycloak:
        condition: service_healthy
      redis:
        condition: service_healthy
      vault:
        condition: service_healthy
      qdrant:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  keycloak:
    image: quay.io/keycloak/keycloak:23.0
    ports:
      - "${KEYCLOAK_PORT:-8080}:8080"
    volumes:
      # Import realm configuration with university users/groups on startup
      - ./config/keycloak/realm-export.json:/opt/keycloak/data/import/realm.json:ro
      # Custom themes (optional)
      - ./config/keycloak/themes:/opt/keycloak/themes:ro
    environment:
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_DB=postgres
      - KC_DB_URL=jdbc:postgresql://keycloak-db:5432/keycloak
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
      # Configure Keycloak to advertise localhost:8080 in discovery documents
      - KC_HOSTNAME=localhost
      - KC_HOSTNAME_PORT=8080
      - KC_HOSTNAME_STRICT=false
      - KC_HTTP_ENABLED=true
      - KC_PROXY=edge
      - KC_HEALTH_ENABLED=true
      - KC_METRICS_ENABLED=true
    command:
      - start-dev
      - --import-realm
    depends_on:
      keycloak-db:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 && echo -e 'GET /health/ready HTTP/1.1\\r\\nHost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3 && cat <&3 | grep -q '200 OK'"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s

  keycloak-db:
    image: postgres:16-alpine
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U keycloak"]
      interval: 10s
      timeout: 3s
      retries: 3

  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  vault:
    image: hashicorp/vault:1.15
    ports:
      - "${VAULT_PORT:-8200}:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=dev-only-token
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    # Dev mode: auto-unsealed, in-memory storage, root token is dev-only-token
    command: server -dev
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "vault", "status", "-address=http://localhost:8200"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s

  qdrant:
    image: qdrant/qdrant:v1.7.4
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    # Qdrant starts quickly, no healthcheck needed for e2e tests
    # The gateway will retry connections if Qdrant isn't ready

volumes:
  gateway-data:
    driver: local
  keycloak-db-data:
    driver: local
  redis-data:
    driver: local
  qdrant-data:
    driver: local
