apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "hadrian.configMapName" . }}
  labels:
    {{- include "hadrian.labels" . | nindent 4 }}
data:
  hadrian.toml: |
    # Hadrian Gateway Configuration
    # Generated by Helm chart {{ .Chart.Name }}-{{ .Chart.Version }}

    [server]
    host = {{ .Values.gateway.server.host | quote }}
    port = {{ .Values.gateway.server.port }}

    # ==========================================================================
    # Database Configuration
    # ==========================================================================
    [database]
    {{- if .Values.postgresql.enabled }}
    # Using PostgreSQL subchart
    type = "postgres"
    url = "postgres://{{ include "hadrian.postgresql.username" . }}:${DATABASE_PASSWORD}@{{ include "hadrian.postgresql.host" . }}:{{ include "hadrian.postgresql.port" . }}/{{ include "hadrian.postgresql.database" . }}?sslmode=prefer"
    {{- else if eq .Values.gateway.database.type "sqlite" }}
    type = "sqlite"
    path = {{ .Values.gateway.database.sqlite.path | quote }}
    {{- else if eq .Values.gateway.database.type "postgres" }}
    type = "postgres"
    {{- if .Values.gateway.database.postgres.url }}
    url = {{ .Values.gateway.database.postgres.url | quote }}
    {{- else }}
    {{- $sslParams := printf "sslmode=%s" .Values.gateway.database.postgres.sslMode }}
    {{- if and .Values.gateway.database.postgres.ssl.enabled .Values.gateway.database.postgres.ssl.existingSecret }}
    {{- $sslMountPath := .Values.gateway.database.postgres.ssl.mountPath | default "/etc/ssl/postgres" }}
    {{- $sslParams = printf "%s&sslrootcert=%s/ca.crt" $sslParams $sslMountPath }}
    {{- end }}
    url = "postgres://{{ .Values.gateway.database.postgres.username }}:${DATABASE_PASSWORD}@{{ .Values.gateway.database.postgres.host }}:{{ .Values.gateway.database.postgres.port }}/{{ .Values.gateway.database.postgres.database }}?{{ $sslParams }}"
    {{- end }}
    {{- if .Values.gateway.database.postgres.readUrl }}
    read_url = {{ .Values.gateway.database.postgres.readUrl | quote }}
    {{- end }}
    {{- end }}

    # ==========================================================================
    # Storage Configuration
    # ==========================================================================
    {{- if .Values.fileStorage.enabled }}
    [storage.files]
    backend = "filesystem"

    [storage.files.filesystem]
    path = {{ .Values.fileStorage.mountPath | quote }}
    create_dir = true
    {{- end }}

    # ==========================================================================
    # Cache Configuration
    # ==========================================================================
    [cache]
    {{- if .Values.redis.enabled }}
    # Using Redis subchart
    type = "redis"
    {{- if .Values.redis.auth.enabled }}
    url = "redis://:${REDIS_PASSWORD}@{{ include "hadrian.redis.host" . }}:{{ include "hadrian.redis.port" . }}"
    {{- else }}
    url = "redis://{{ include "hadrian.redis.host" . }}:{{ include "hadrian.redis.port" . }}"
    {{- end }}
    {{- else if eq .Values.gateway.cache.type "memory" }}
    type = "memory"
    {{- else if eq .Values.gateway.cache.type "redis" }}
    type = "redis"
    {{- if .Values.gateway.cache.redis.cluster }}
    {{- /* Cluster mode: use clusterNodes if provided, otherwise single host */}}
    {{- if .Values.gateway.cache.redis.clusterNodes }}
    url = {{ .Values.gateway.cache.redis.clusterNodes | quote }}
    {{- else }}
    url = "redis://{{ .Values.gateway.cache.redis.host }}:{{ .Values.gateway.cache.redis.port }}"
    {{- end }}

    [cache.cluster]
    read_from_replicas = {{ .Values.gateway.cache.redis.readFromReplicas | default true }}
    retries = {{ .Values.gateway.cache.redis.clusterRetries | default 3 }}
    retry_delay_ms = {{ .Values.gateway.cache.redis.clusterRetryDelayMs | default 100 }}
    connection_timeout_secs = {{ .Values.gateway.cache.redis.clusterConnectionTimeoutSecs | default 5 }}
    response_timeout_secs = {{ .Values.gateway.cache.redis.clusterResponseTimeoutSecs | default 1 }}
    {{- else if .Values.gateway.cache.redis.url }}
    url = {{ .Values.gateway.cache.redis.url | quote }}
    {{- else if or .Values.gateway.cache.redis.password .Values.gateway.cache.redis.existingSecret }}
    url = "redis://:${REDIS_PASSWORD}@{{ .Values.gateway.cache.redis.host }}:{{ .Values.gateway.cache.redis.port }}"
    {{- else }}
    url = "redis://{{ .Values.gateway.cache.redis.host }}:{{ .Values.gateway.cache.redis.port }}"
    {{- end }}
    {{- end }}

    # ==========================================================================
    # Authentication Configuration
    # ==========================================================================
    [auth.gateway]
    type = {{ .Values.gateway.auth.gateway.type | quote }}
    {{- if eq .Values.gateway.auth.gateway.type "api_key" }}
    header_name = {{ .Values.gateway.auth.gateway.headerName | quote }}
    key_prefix = {{ .Values.gateway.auth.gateway.keyPrefix | quote }}
    cache_ttl_secs = {{ .Values.gateway.auth.gateway.cacheTtlSecs }}
    {{- end }}

    # ==========================================================================
    # Provider Configuration
    # ==========================================================================
    [providers]
    default_provider = {{ .Values.gateway.providers.defaultProvider | quote }}

    {{- if .Values.gateway.providers.openrouter.enabled }}

    [providers.openrouter]
    type = "open_ai"
    api_key = "${OPENROUTER_API_KEY}"
    base_url = {{ .Values.gateway.providers.openrouter.baseUrl | quote }}
    timeout_secs = {{ .Values.gateway.providers.openrouter.timeoutSecs }}
    {{- end }}

    {{- if .Values.gateway.providers.openai.enabled }}

    [providers.openai]
    type = "open_ai"
    api_key = "${OPENAI_API_KEY}"
    base_url = {{ .Values.gateway.providers.openai.baseUrl | quote }}
    timeout_secs = {{ .Values.gateway.providers.openai.timeoutSecs }}
    {{- end }}

    {{- if .Values.gateway.providers.anthropic.enabled }}

    [providers.anthropic]
    type = "anthropic"
    api_key = "${ANTHROPIC_API_KEY}"
    base_url = {{ .Values.gateway.providers.anthropic.baseUrl | quote }}
    timeout_secs = {{ .Values.gateway.providers.anthropic.timeoutSecs }}
    {{- end }}

    {{- if .Values.gateway.providers.test.enabled }}

    [providers.test]
    type = "test"
    model_name = {{ .Values.gateway.providers.test.modelName | quote }}
    timeout_secs = {{ .Values.gateway.providers.test.timeoutSecs }}
    {{- end }}

    # ==========================================================================
    # Feature Flags
    # ==========================================================================
    {{- if .Values.gateway.features.fileSearch.enabled }}

    [features.file_search]
    enabled = true
    {{- end }}

    {{- if .Values.gateway.features.guardrails.enabled }}

    [features.guardrails]
    enabled = true
    {{- end }}

    {{- if .Values.gateway.features.webSearch.enabled }}

    [features.web_search]
    enabled = true
    {{- end }}

    # ==========================================================================
    # Observability Configuration
    # ==========================================================================
    [observability.logging]
    format = {{ .Values.gateway.observability.logging.format | quote }}

    {{- if .Values.gateway.observability.metrics.enabled }}

    [observability.metrics]
    enabled = true
    {{- if .Values.gateway.observability.metrics.prometheusQueryUrl }}
    prometheus_query_url = {{ .Values.gateway.observability.metrics.prometheusQueryUrl | quote }}
    {{- end }}

    [observability.metrics.prometheus]
    enabled = true
    path = {{ .Values.gateway.observability.metrics.path | quote }}
    {{- end }}

    {{- if .Values.gateway.observability.tracing.enabled }}

    [observability.tracing]
    enabled = true
    service_name = "${OTEL_SERVICE_NAME}"

    [observability.tracing.otlp]
    endpoint = "${OTEL_EXPORTER_OTLP_ENDPOINT}"
    {{- end }}
